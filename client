import asyncio, argparse, random, time
from gamenet import GameNetQUICClient
from common import random_pokemon_payload

async def main(target:str, pps:float, duration:float, rel_ratio:float, verify:bool):
    api = GameNetQUICClient(verify=verify)
    await api.connect(target)
    try:
        interval = 1.0/pps
        start = time.time()
        while time.time() - start < duration:
            flag = 1 if random.random() < rel_ratio else 0
            payload = random_pokemon_payload(flag)
            await api.send_packet(flag, payload)
            await asyncio.sleep(interval)
    finally:
        await api.close()

if __name__ == "__main__":
    ap = argparse.ArgumentParser()
    ap.add_argument("--target", default="127.0.0.1:4433")
    ap.add_argument("--pps", type=float, default=30.0)
    ap.add_argument("--duration", type=float, default=10.0)
    ap.add_argument("--rel-ratio", type=float, default=0.5)
    ap.add_argument("--verify", action="store_true")
    args = ap.parse_args()
    asyncio.run(main(args.target, args.pps, args.duration, args.rel_ratio, args.verify))
